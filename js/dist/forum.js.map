{"version":3,"file":"forum.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;;IAEqBK;;;;;;;;;SACnBC,SAAA,gBAAOC,KAAP,EAAc;IACZ,qBAAMD,MAAN,YAAaC,KAAb;;IACA,KAAKC,OAAL,GAAe,IAAf;IACA,KAAKC,IAAL,GAAYF,KAAK,CAACG,KAAN,CAAYD,IAAxB;IACA,KAAKE,cAAL,GAAsBC,MAAM,CAACC,MAAP,OAAAD,MAAM,GAAQ,EAAR,SAAeE,KAAK,CAACC,IAAN,CAAW,KAAKN,IAAL,CAAUO,UAArB,EAAiC;MAAA;;MAAA,IAAGC,IAAH,QAAGA,IAAH;MAAA,IAASC,KAAT,QAASA,KAAT;MAAA,yBAAyBD,IAAzB,IAAgCC,KAAhC;IAAA,CAAjC,CAAf,EAA5B;IACA,KAAKC,IAAL,GAAY,IAAZ;IACA,KAAKC,iBAAL,GAAyBb,KAAK,CAACG,KAAN,CAAYU,iBAArC;IAEA,KAAKC,SAAL;EACD;;SAEDC,OAAA,gBAAO;IAAA;;IACL,IAAMC,OAAO,GAAG;MACdf,OAAO,EAAE,KAAKA;IADA,CAAhB;IAIA,OACE;MAAK,SAAS,EAAE,iBAAiBL,oEAAS,CAACoB,OAAD;IAA1C,GACG,KAAKf,OAAL,IAAgB,KAAKgB,QAAL,EAAhB,GACC;MAAK,SAAS,EAAC;IAAf,GACG,KAAKhB,OAAL,GACC,EAAC,kFAAD;MAAkB,OAAO,EAAC,OAA1B;MAAkC,kBAAkB,EAAEL,oEAAS,CAAC,qBAAD,EAAwB,KAAKK,OAAL,IAAgB,QAAxC,CAA/D;MAAkH,IAAI,EAAC;IAAvH,EADD,GAGC;MAAK,GAAG,EAAE,KAAKgB,QAAL,EAAV;MAA2B;IAA3B,EAJJ,CADD,GAQG,IATN,EAUE;MAAK,SAAS,EAAC;IAAf,GACE;MAAK,SAAS,EAAC;IAAf,GAAoC,KAAKC,OAAL,mCAAa,KAAKN,IAAlB,qBAAa,WAAWO,KAAxB,8CAAiC,KAAKP,IAAtC,qBAAiC,YAAWQ,KAA5C,CAApC,CADF,EAEE;MAAK,SAAS,EAAC;IAAf,GAA0C,KAAKnB,OAAL,GAAe,EAAf,2CAAoB,KAAKW,IAAzB,qBAAoB,YAAWS,WAA/B,oCAA8C,EAAxF,CAFF,EAGE;MAAK,SAAS,EAAC;IAAf,GACG,KAAKR,iBAAL,GAAyB;MAAK,GAAG,EAAE,KAAKS,UAAL,EAAV;MAA6B;IAA7B,EAAzB,GAA6E5B,iEAAI,CAAC,0BAAD,CADpF,EAEG,KAAKwB,OAAL,gBAAa,KAAKN,IAAlB,qBAAa,YAAWW,SAAxB,CAFH,CAHF,CAVF,CADF;EAqBD;;SAEDC,WAAA,kBAASxB,KAAT,EAAgB;IACd,KAAKE,IAAL,CAAUuB,UAAV,CAAqBC,YAArB,CAAkC1B,KAAK,CAAC2B,GAAxC,EAA6C,KAAKzB,IAAlD;EACD;;SAEDgB,UAAA,iBAAQU,IAAR,EAAc;IACZ,OAAO,EAAC,sEAAD,EAAU,KAAKxB,cAAf,EAAgC,KAAKH,OAAL,GAAe,KAAK4B,SAAL,EAAf,GAAkCD,IAAlC,WAAkCA,IAAlC,GAA0C,KAAKC,SAAL,EAA1E,CAAP;EACD;;SAEDC,UAAA,mBAAU;IACR,OAAO,KAAK5B,IAAL,CAAU6B,IAAjB;EACD;;SAEDF,YAAA,qBAAY;IACV,OAAO,KAAKC,OAAL,GAAeE,KAAf,CAAqB,GAArB,EAA0B,CAA1B,CAAP;EACD;;SAEDf,WAAA,oBAAW;IAAA;;IACT,0CAAO,KAAKL,IAAZ,qBAAO,YAAWqB,KAAlB,+BAA2B,KAAKX,UAAL,EAA3B;EACD;;SAEDA,aAAA,sBAAa;IACX,OAAO,KAAKT,iBAAL,GAAyB,yDAAyD,KAAKgB,SAAL,EAAlF,GAAqG,IAA5G;EACD;;SAEDf,YAAA,qBAAY;IAAA;;IACVoB,GAAG,CACAC,OADH,CACW;MACPC,GAAG,EAAEF,GAAG,CAACG,KAAJ,CAAUC,SAAV,CAAoB,QAApB,IAAgC,8BAAhC,GAAiEC,kBAAkB,CAAC,KAAKT,OAAL,EAAD,CADjF;MAEPU,MAAM,EAAE;IAFD,CADX,EAKGC,IALH,CAKQ,UAAC7B,IAAD,EAAU;MACd,KAAI,CAAC8B,OAAL,CAAa9B,IAAb;;MACA,KAAI,CAACX,OAAL,GAAe,KAAf;IACD,CARH;EASD;;SAEDyC,UAAA,iBAAQ9B,IAAR,EAAc;IACZ,KAAKA,IAAL,GAAYA,IAAZ;IACA+B,CAAC,CAACC,MAAF;EACD;;;EA/EsCnD;;;;;;;;;;;;;;;;;;;;;;;;;;;ACNzC;AACA;AACA;AACA;AAEAyC,wEAAA,CAAqB,+BAArB,EAAsD,YAAM;EAC1DW,4DAAM,CAACC,sFAAD,EAAwB,gBAAxB,EAA0C,YAAY;IAAA;;IAC1D,IAAMI,0BAA0B,GAAG,SAA7BA,0BAA6B,CAACC,GAAD,EAAS;MAC1C,IAAMC,OAAO,GAAGlB,uEAAA,CAAoBiB,GAApB,CAAhB;MACA,OAAOC,OAAO,GAAGA,OAAO,CAACpB,KAAR,CAAc,OAAd,EAAuBqB,GAAvB,CAA2B,UAACC,IAAD;QAAA,OAAUA,IAAI,CAACC,IAAL,EAAV;MAAA,CAA3B,CAAH,GAAuD,EAArE;IACD,CAHD;;IAKA,IAAMC,MAAM,GAAG,SAATA,MAAS,CAACC,MAAD,EAASC,QAAT,EAAsB;MACnC,IAAI,MAAMA,QAAQ,CAACC,MAAnB,EAA2B;QACzB,OAAO,KAAP;MACD;;MACD,IAAID,QAAQ,CAACE,QAAT,CAAkBH,MAAlB,CAAJ,EAA+B;QAC7B,OAAO,IAAP;MACD;;MACD,qDAAmBC,QAAnB,wCAA6B;QAAA,IAAlBJ,IAAkB;QAC3B,IAAMO,MAAM,GAAGP,IAAI,CAChBQ,OADY,CACJ,oCADI,EACkC,MADlC,EAEZA,OAFY,CAEJ,KAFI,EAEG,IAFH,EAGZA,OAHY,CAGJ,KAHI,EAGG,GAHH,CAAf;;QAIA,IAAIL,MAAM,CAACM,KAAP,CAAa,IAAIC,MAAJ,CAAWH,MAAX,EAAmB,GAAnB,CAAb,CAAJ,EAA2C;UACzC,OAAO,IAAP;QACD;MACF;;MACD,OAAO,KAAP;IACD,CAjBD;;IAmBA,IAAMI,cAAc,GAAGf,0BAA0B,CAAC,kCAAD,CAAjD;IACA,IAAMgB,cAAc,GAAGhB,0BAA0B,CAAC,kCAAD,CAAjD;IACA,IAAMrC,iBAAiB,2BAAGqB,uEAAA,CAAoB,0CAApB,CAAH,mCAAsE,KAA7F;IAEA,KAAKiC,OAAL,CAAaC,gBAAb,CAA8B,mBAA9B,EAAmDC,OAAnD,CAA2D,UAACnE,IAAD,EAAU;MACnE,IAAIA,IAAI,CAACN,SAAL,CAAe0E,QAAf,CAAwB,aAAxB,KAA0CpE,IAAI,CAACN,SAAL,CAAe0E,QAAf,CAAwB,aAAxB,CAA9C,EAAsF;QACpF;MACD;;MAED,IAAMC,aAAa,GAAGrE,IAAI,CAAC6B,IAAL,CAAU+B,OAAV,CAAkB,wBAAlB,EAA4C,IAA5C,CAAtB;;MAEA,IACGI,cAAc,CAACP,MAAf,IAAyB,CAACH,MAAM,CAACe,aAAD,EAAgBL,cAAhB,CAAjC,IACCD,cAAc,CAACN,MAAf,IAAyBH,MAAM,CAACe,aAAD,EAAgBN,cAAhB,CADhC,IAEA/D,IAAI,CAAC6B,IAAL,CAAU+B,OAAV,CAAkB,KAAlB,EAAyB,EAAzB,MAAiC5D,IAAI,CAACsE,WAAL,CAAiBV,OAAjB,CAAyB,KAAzB,EAAgC,EAAhC,CAHnC,EAIE;QACA;MACD;;MAED,IAAI5B,uEAAA,CAAoB,yCAApB,KAAkEqC,aAAa,CAACR,KAAd,CAAoB,6CAApB,CAAtE,EAA0I;QACxI;MACD;;MAEDpB,CAAC,CAAC8B,KAAF,CAAQvE,IAAR,EAAc;QACZa,IAAI,EAAE,gBAAY;UAChB,OAAO4B,CAAC,CAAC7C,+DAAD,EAAc;YAAEI,IAAI,EAAJA,IAAF;YAAQW,iBAAiB,EAAEA;UAA3B,CAAd,CAAR;QACD;MAHW,CAAd;IAKD,CAxBD;EAyBD,CAtDK,CAAN;AAuDD,CAxDD;;;;;;;;;;;ACLA;;;;;;;;;;;ACAA;;;;;;;;;;;ACAA;;;;;;;;;;;ACAA;;;;;;;;;;;ACAA;;;;;;;;;;;ACAA;;;;;;;;;;;ACAA;;;;;;;;;;;ACAA;;;;;;;;;;;;;;;;ACAA;AACe,SAAS8D,cAAT,CAAwBC,QAAxB,EAAkCC,UAAlC,EAA8C;EAC3DD,QAAQ,CAAC3B,SAAT,GAAqB5C,MAAM,CAACyE,MAAP,CAAcD,UAAU,CAAC5B,SAAzB,CAArB;EACA2B,QAAQ,CAAC3B,SAAT,CAAmB8B,WAAnB,GAAiCH,QAAjC;EACAF,8DAAc,CAACE,QAAD,EAAWC,UAAX,CAAd;AACD;;;;;;;;;;;;;;;ACLc,SAASG,eAAT,CAAyBC,CAAzB,EAA4BC,CAA5B,EAA+B;EAC5CF,eAAe,GAAG3E,MAAM,CAACqE,cAAP,GAAwBrE,MAAM,CAACqE,cAAP,CAAsBS,IAAtB,EAAxB,GAAuD,SAASH,eAAT,CAAyBC,CAAzB,EAA4BC,CAA5B,EAA+B;IACtGD,CAAC,CAACG,SAAF,GAAcF,CAAd;IACA,OAAOD,CAAP;EACD,CAHD;EAIA,OAAOD,eAAe,CAACC,CAAD,EAAIC,CAAJ,CAAtB;AACD;;;;;;UCND;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;;WCtBA;WACA;WACA;WACA;WACA;WACA,iCAAiC,WAAW;WAC5C;WACA;;;;;WCPA;WACA;WACA;WACA;WACA,yCAAyC,wCAAwC;WACjF;WACA;WACA;;;;;WCPA;;;;;WCAA;WACA;WACA;WACA,uDAAuD,iBAAiB;WACxE;WACA,gDAAgD,aAAa;WAC7D","sources":["webpack://@datlechin/flarum-link-preview/./src/forum/components/LinkPreview.js","webpack://@datlechin/flarum-link-preview/./src/forum/index.js","webpack://@datlechin/flarum-link-preview/external root \"flarum.core.compat['common/Component']\"","webpack://@datlechin/flarum-link-preview/external root \"flarum.core.compat['common/components/Link']\"","webpack://@datlechin/flarum-link-preview/external root \"flarum.core.compat['common/components/LoadingIndicator']\"","webpack://@datlechin/flarum-link-preview/external root \"flarum.core.compat['common/extend']\"","webpack://@datlechin/flarum-link-preview/external root \"flarum.core.compat['common/helpers/icon']\"","webpack://@datlechin/flarum-link-preview/external root \"flarum.core.compat['common/utils/classList']\"","webpack://@datlechin/flarum-link-preview/external root \"flarum.core.compat['forum/app']\"","webpack://@datlechin/flarum-link-preview/external root \"flarum.core.compat['forum/components/CommentPost']\"","webpack://@datlechin/flarum-link-preview/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://@datlechin/flarum-link-preview/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://@datlechin/flarum-link-preview/webpack/bootstrap","webpack://@datlechin/flarum-link-preview/webpack/runtime/compat get default export","webpack://@datlechin/flarum-link-preview/webpack/runtime/define property getters","webpack://@datlechin/flarum-link-preview/webpack/runtime/hasOwnProperty shorthand","webpack://@datlechin/flarum-link-preview/webpack/runtime/make namespace object"],"sourcesContent":["import Component from 'flarum/common/Component';\nimport icon from 'flarum/common/helpers/icon';\nimport Link from 'flarum/common/components/Link';\nimport classList from 'flarum/common/utils/classList';\nimport LoadingIndicator from 'flarum/common/components/LoadingIndicator';\n\nexport default class LinkPreview extends Component {\n  oninit(vnode) {\n    super.oninit(vnode);\n    this.loading = true;\n    this.link = vnode.attrs.link;\n    this.linkAttributes = Object.assign({}, ...Array.from(this.link.attributes, ({ name, value }) => ({ [name]: value })));\n    this.data = null;\n    this.useGoogleFavicons = vnode.attrs.useGoogleFavicons;\n\n    this.fetchData();\n  }\n\n  view() {\n    const classes = {\n      loading: this.loading,\n    };\n\n    return (\n      <div className={'LinkPreview ' + classList(classes)}>\n        {this.loading || this.getImage() ? (\n          <div className=\"LinkPreview-image\">\n            {this.loading ? (\n              <LoadingIndicator display=\"unset\" containerClassName={classList('LinkPreview-loading', this.loading && 'active')} size=\"small\" />\n            ) : (\n              <img src={this.getImage()} data-link-preview />\n            )}\n          </div>\n        ) : null}\n        <div className=\"LinkPreview-main\">\n          <div className=\"LinkPreview-title\">{this.getLink(this.data?.title ?? this.data?.error)}</div>\n          <div className=\"LinkPreview-description\">{this.loading ? '' : this.data?.description ?? ''}</div>\n          <div className=\"LinkPreview-domain\">\n            {this.useGoogleFavicons ? <img src={this.getFavicon()} data-link-preview /> : icon('fas fa-external-link-alt')}\n            {this.getLink(this.data?.site_name)}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  oncreate(vnode) {\n    this.link.parentNode.insertBefore(vnode.dom, this.link);\n  }\n\n  getLink(text) {\n    return <Link {...this.linkAttributes}>{this.loading ? this.getDomain() : text ?? this.getDomain()}</Link>;\n  }\n\n  getHref() {\n    return this.link.href;\n  }\n\n  getDomain() {\n    return this.getHref().split('/')[2];\n  }\n\n  getImage() {\n    return this.data?.image ?? this.getFavicon();\n  }\n\n  getFavicon() {\n    return this.useGoogleFavicons ? 'https://www.google.com/s2/favicons?sz=64&domain_url=' + this.getDomain() : null;\n  }\n\n  fetchData() {\n    app\n      .request({\n        url: app.forum.attribute('apiUrl') + '/datlechin-link-preview?url=' + encodeURIComponent(this.getHref()),\n        method: 'GET',\n      })\n      .then((data) => {\n        this.setData(data);\n        this.loading = false;\n      });\n  }\n\n  setData(data) {\n    this.data = data;\n    m.redraw();\n  }\n}\n","import app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport CommentPost from 'flarum/forum/components/CommentPost';\nimport LinkPreview from './components/LinkPreview';\n\napp.initializers.add('datlechin/flarum-link-preview', () => {\n  extend(CommentPost.prototype, 'refreshContent', function () {\n    const getMultiDimensionalSetting = (key) => {\n      const setting = app.forum.attribute(key);\n      return setting ? setting.split(/[,\\n]/).map((item) => item.trim()) : [];\n    };\n\n    const inList = (needle, haystack) => {\n      if (0 === haystack.length) {\n        return false;\n      }\n      if (haystack.includes(needle)) {\n        return true;\n      }\n      for (const item of haystack) {\n        const quoted = item\n          .replace(/[-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, '\\\\$&')\n          .replace('\\\\*', '.*')\n          .replace('\\\\?', '.');\n        if (needle.match(new RegExp(quoted, 'i'))) {\n          return true;\n        }\n      }\n      return false;\n    };\n\n    const blacklistArray = getMultiDimensionalSetting('datlechin-link-preview.blacklist');\n    const whitelistArray = getMultiDimensionalSetting('datlechin-link-preview.whitelist');\n    const useGoogleFavicons = app.forum.attribute('datlechin-link-preview.useGoogleFavicons') ?? false;\n\n    this.element.querySelectorAll('.Post-body a[rel]').forEach((link) => {\n      if (link.classList.contains('PostMention') || link.classList.contains('UserMention')) {\n        return;\n      }\n\n      const normalizedUrl = link.href.replace(/^https?:\\/\\/(.+?)\\/?$/i, '$1');\n\n      if (\n        (whitelistArray.length && !inList(normalizedUrl, whitelistArray)) ||\n        (blacklistArray.length && inList(normalizedUrl, blacklistArray)) ||\n        link.href.replace(/\\/$/, '') !== link.textContent.replace(/\\/$/, '')\n      ) {\n        return;\n      }\n\n      if (app.forum.attribute('datlechin-link-preview.convertMediaURLs') && normalizedUrl.match(/\\.(jpe?g|png|gif|svg|webp|mp3|mp4|m4a|wav)$/)) {\n        return;\n      }\n\n      m.mount(link, {\n        view: function () {\n          return m(LinkPreview, { link, useGoogleFavicons: useGoogleFavicons });\n        },\n      });\n    });\n  });\n});\n","module.exports = flarum.core.compat['common/Component'];","module.exports = flarum.core.compat['common/components/Link'];","module.exports = flarum.core.compat['common/components/LoadingIndicator'];","module.exports = flarum.core.compat['common/extend'];","module.exports = flarum.core.compat['common/helpers/icon'];","module.exports = flarum.core.compat['common/utils/classList'];","module.exports = flarum.core.compat['forum/app'];","module.exports = flarum.core.compat['forum/components/CommentPost'];","import setPrototypeOf from \"./setPrototypeOf.js\";\nexport default function _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  setPrototypeOf(subClass, superClass);\n}","export default function _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};"],"names":["Component","icon","Link","classList","LoadingIndicator","LinkPreview","oninit","vnode","loading","link","attrs","linkAttributes","Object","assign","Array","from","attributes","name","value","data","useGoogleFavicons","fetchData","view","classes","getImage","getLink","title","error","description","getFavicon","site_name","oncreate","parentNode","insertBefore","dom","text","getDomain","getHref","href","split","image","app","request","url","forum","attribute","encodeURIComponent","method","then","setData","m","redraw","extend","CommentPost","initializers","add","prototype","getMultiDimensionalSetting","key","setting","map","item","trim","inList","needle","haystack","length","includes","quoted","replace","match","RegExp","blacklistArray","whitelistArray","element","querySelectorAll","forEach","contains","normalizedUrl","textContent","mount","setPrototypeOf","_inheritsLoose","subClass","superClass","create","constructor","_setPrototypeOf","o","p","bind","__proto__"],"sourceRoot":""}